## Java Programming Tutorial
### Java Native Interface (JNI)

有名的案例:netty的transport-native-epoll通过NativeLibraryLoader使用了linux的epoll
` PS:通常不建议这么玩 :) `

#### 1.Getting Started

按照惯例从HelloWorld开始

##### Step.1
内容如下:
```
public class HelloJNI {
   static {
      System.loadLibrary("hello"); // Load native library at runtime
                                   // hello.dll (Windows) or libhello.so (Unixes)
   }
 
   // Declare a native method sayHello() that receives nothing and returns void
   private native void sayHello();
 
   // Test Driver
   public static void main(String[] args) {
      new HelloJNI().sayHello();  // invoke the native method
   }
}
```
*在Class Loading时其中System.loadLibrary()加载native Library "Hello",通常这个文件在Window上是"hello.dll",在Unix上是"libhello.so",但是必要的一点是需要添加-Djava.library.path=path_to_lib否则会抛出UnsatisfiedLinkError*

##### Step.2
先看看代码变成了啥,对如上文件执行`javac HelloJNI.java`,在通过`javap -c HelloJNI.class`
```
Compiled from "HelloJNI.java"
public class org.doraemon.treasures.research.HelloJNI {
  public org.doraemon.treasures.research.HelloJNI();
    Code:
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object."<init>":()V
       4: return

  public static void main(java.lang.String[]);
    Code:
       0: new           #2                  // class org/doraemon/treasures/research/HelloJNI
       3: dup
       4: invokespecial #3                  // Method "<init>":()V
       7: invokespecial #4                  // Method sayHello:()V
      10: return

  static {};
    Code:
       0: ldc           #5                  // String hello
       2: invokestatic  #6                  // Method java/lang/System.loadLibrary:(Ljava/lang/String;)V
       5: return
}

```
你要是想知道这些指令是啥建议看看<<JVM虚拟机规范>>`+`<<深入理解Java虚拟机>>,至今水平不足前五章
接着问题来了,要是全部手写所有的头文件岂不是坑爹死,所以可以在根包处执行`javah -d [output_directory] org.doraemon.treasures.research.HelloJNI` 这样子就自动生成了头文件
```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class org_doraemon_treasures_research_HelloJNI */

#ifndef _Included_org_doraemon_treasures_research_HelloJNI
#define _Included_org_doraemon_treasures_research_HelloJNI
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     org_doraemon_treasures_research_HelloJNI
 * Method:    sayHello
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_org_doraemon_treasures_research_HelloJNI_sayHello
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```
其中你可以注意到C方法名为Java_{package_and_classname}_{function_name}(JNI arguments),其中JNIEnv* 是JNIEnv的指针,能去使用JNI方法,jobject就是Java里面的this`this java object`接下来开搞
##### Step.3
实现你的梦想
```
#include <jni.h>
#include <stdio.h>
#include "org_doraemon_treasures_research_HelloJNI.h"

JNIEXPORT void JNICALL Java_org_doraemon_treasures_research_HelloJNI_sayHello(JNIEnv *env, jobject thisObj){
    printf("Hello World!\n");
    return;
}
```
*And Then*
```
gcc -Wl -I"${JAVA_HOME}/include" -I"${JAVA_HOME}/include/linux" -shared -o hello.dll org_doraemon_treasures_research_HelloJNI.c
```






